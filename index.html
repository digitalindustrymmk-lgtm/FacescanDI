<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ប្រព័ន្ធស្កេនមុខឌីជីថល</title>
    <link rel="icon" href="https://img.freepik.com/premium-vector/face-scan-icon_933463-79729.jpg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" xintegrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Moul&display=swap');
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .main-content {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.is-open {
            transform: translateX(0);
        }
        .nav-link.active {
            background: #4f46e5;
            color: white;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.39);
        }
        .video-container video {
            position: absolute; top: 50%; left: 50%; width: 100%; height: 100%;
            object-fit: cover; transform: translate(-50%, -50%) scaleX(-1);
        }
        .video-container {
            position: relative; border-radius: 50%; overflow: hidden;
            border: 5px solid transparent; transition: all 0.4s ease;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .video-container.ready {
            border-color: #4ade80; box-shadow: 0 0 25px rgba(74, 222, 128, 0.6);
        }
        .scanner-line {
            position: absolute; left: 0; width: 100%; height: 3px;
            background: linear-gradient(to right, transparent, #4ade80, transparent);
            box-shadow: 0 0 10px #4ade80; animation: scan 3s linear infinite;
            opacity: 0; transition: opacity 0.3s;
        }
        .video-container.ready .scanner-line { opacity: 1; }
        @keyframes scan { 0% { top: 0%; } 50% { top: 100%; } 100% { top: 0%; } }
        .modal { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(5px); }
        .modal-content { background: #1e293b; border: 1px solid #475569; }
        .khmer-title { font-family: "Moul", serif; }
        .table-container { height: calc(100vh - 280px); overflow-y: auto; }
        #student-list { max-height: 40vh; overflow-y: auto; }
        #student-list li:hover { background-color: #334155; }
        #student-list li.completed {
            color: #4ade80 !important; /* Green */
            font-weight: 600; opacity: 0.7; pointer-events: none;
        }
        .filter-select {
            background-color: #E5E7EB; color: #111827;
            padding: 0.5rem 2rem 0.5rem 0.75rem; font-size: 0.875rem;
            border-radius: 0.5rem; border: 1px solid #9CA3AF;
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;
        }
        .filter-select option { background: #F3F4F6; color: #000000; }
        @media (min-width: 768px) {
            .filter-select { padding: 0.6rem 2.5rem 0.6rem 1rem; font-size: 1rem; }
        }
        ::-webkit-scrollbar { width: 8px; height: 8px;}
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    </style>
</head>

<body class="bg-slate-900 text-slate-200">

    <div class="relative min-h-screen md:flex">
        <div id="sidebar-backdrop" class="hidden md:hidden fixed inset-0 bg-black/50 z-30"></div>

        <aside id="sidebar" class="fixed top-0 left-0 w-64 h-full bg-slate-800/80 backdrop-blur-lg z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">

    <div class="text-center py-6 mb-4">
        <img src="di_logo.png" alt="Logo" class="w-20 h-20 rounded-full mx-auto mb-2 shadow-lg">
        <h2 class="text-xl font-bold text-white khmer-title">ឧស្សាហកម្មឌីជីថល</h2>
    </div>

    <ul class="flex-1 flex flex-col space-y-2 px-4 overflow-y-auto">
        <li>
            <a href="#" id="nav-scan" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white">
                <i class="fas fa-camera-retro fa-fw"></i>
                <span class="font-semibold">ថតរូប</span>
            </a>
        </li>
        <li>
            <a href="#" id="nav-list" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white">
                <i class="fas fa-users fa-fw"></i>
                <span class="font-semibold">ទិន្នន័យរូបភាពនិស្សិត</span>
            </a>
        </li>
        <li>
            <a href="#" id="nav-records" class="nav-link flex items-center gap-3 px-4 py-3 rounded-lg text-slate-300 hover:bg-indigo-500 hover:text-white">
                <i class="fas fa-database fa-fw"></i>
                <span class="font-semibold">រូបភាពបានរក្សាទុក</span>
            </a>
        </li>
    </ul>

    <footer class="p-4 border-t border-slate-700/50 text-slate-400 text-sm">
        <div class="flex flex-col items-center sm:flex-row sm:justify-between gap-2">
            <p class="text-center sm:text-left">&copy; 2025 by IT Support</p>
            <div class="flex items-center gap-3">
                <a href="#" target="_blank" class="hover:text-white transition-colors" title="Telegram">
                    <i class="fab fa-telegram fa-lg"></i>
                </a>
            </div>
        </div>
    </footer>
</aside>


        <div id="content-wrapper" class="flex flex-col flex-1 md:ml-64 transition-all duration-300 ease-in-out">
            <header class="w-full h-16 bg-slate-800/50 backdrop-blur-lg flex-shrink-0 flex items-center px-6 sticky top-0 z-20">
                <button id="menu-btn" class="text-white mr-4 md:hidden"><i class="fas fa-bars text-xl"></i></button>
                <h1 class="text-xl font-bold text-white khmer-title">ប្រព័ន្ធគ្រប់គ្រងទិន្នន័យរូបភាព</h1>
            </header>

            <main class="w-full flex-1 p-4 md:p-8">
                <div id="page-scan">
                             <div class="main-content rounded-2xl p-6">
                                <div class="container w-full max-w-md mx-auto relative">
                                    <button id="back-btn" class="hidden absolute -top-2 -left-2 w-10 h-10 bg-slate-700/50 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-slate-600/50 transition z-20" title="Back to Selection"><i class="fas fa-arrow-left"></i></button>
                                    <h1 class="text-center text-2xl mb-2 text-white khmer-title">ប្រព័ន្ធស្កេនមុខឌីជីថល</h1>
                                    <p id="subtitle" class="text-center text-slate-400 mb-6">សូមជ្រើសរើសអត្តលេខរបស់អ្នក</p>

                                    <div id="selection-area" class="mb-5">
                                        <input type="text" id="student-search-input" placeholder="ស្វែងរកអត្តលេខ ឬឈ្មោះ..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4">
                                        <ul id="student-list" class="space-y-1">
                                             <li class="text-center text-slate-400 p-4">Loading students...</li>
                                        </ul>
                                    </div>

                                    <div id="camera-section" class="hidden flex flex-col items-center space-y-4">
                                        <div id="video-wrapper" class="video-container w-[90%] mx-auto aspect-square">
                                            <video id="video" autoplay muted playsinline></video>
                                            <div class="scanner-line"></div>
                                        </div>
                                        <div class="flex items-center justify-center gap-4">
                                            <button id="switch-camera-btn" class="hidden w-14 h-14 bg-slate-700/50 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-slate-600/50 transition" title="Switch Camera"><i class="fas fa-sync-alt fa-lg"></i></button>
                                            <button id="manual-capture-btn" class="hidden w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center text-white hover:bg-indigo-700 transition shadow-lg" title="Capture Photo"><i class="fas fa-camera fa-2x"></i></button>
                                        </div>
                                        <canvas id="capture-canvas" class="hidden"></canvas>
                                        <img id="photo-preview" class="hidden w-[90%] mx-auto aspect-square rounded-full border-4 border-green-400 object-cover shadow-lg">
                                        <p id="face-status" class="text-center text-sm h-5 font-semibold text-slate-400"></p>
                                        <div class="flex flex-col w-full space-y-3">
                                            <button id="upload-btn" class="hidden w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-semibold hover:opacity-90 transition shadow-lg">បញ្ជូនរូបភាព</button>
                                            <button id="retake-btn" class="hidden w-full bg-slate-600 text-white py-3 rounded-xl font-semibold hover:bg-slate-700 transition">ថតម្តងទៀត</button>
                                        </div>
                                    </div>
                                </div>
                             </div>
                </div>

                <div id="page-list" class="hidden main-content rounded-2xl p-6 h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h1 class="text-2xl text-white khmer-title">ទិន្នន័យរូបភាពនិស្សិត</h1>
                        <div class="flex gap-4 w-full md:w-auto">
                            <input type="text" id="list-search-input" placeholder="ស្វែងរកអត្តលេខឬឈ្មោះ..." class="w-full bg-slate-700 border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <select id="list-class-filter" class="filter-select w-full md:w-auto"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-left">
                        <div class="bg-slate-700/50 p-4 rounded-lg flex items-center gap-4"><i class="fas fa-users fa-2x text-slate-400"></i><div><p class="text-slate-400">ចំនួននិស្សិតសរុប</p><p id="list-total-count" class="text-2xl font-bold text-white">-</p></div></div>
                        <div class="bg-green-800/30 p-4 rounded-lg flex items-center gap-4"><i class="fas fa-user-check fa-2x text-green-400"></i><div><p class="text-green-400">និស្សិតមានរូបភាព</p><p id="list-completed-count" class="text-2xl font-bold text-green-400">-</p></div></div>
                        <div class="bg-red-800/30 p-4 rounded-lg flex items-center gap-4"><i class="fas fa-user-clock fa-2x text-red-400"></i><div><p class="text-red-400">និស្សិតគ្មានរូបភាព</p><p id="list-pending-count" class="text-2xl font-bold text-red-400">-</p></div></div>
                    </div>
                    <div id="list-container" class="table-container flex-1 overflow-x-auto">
                        <div id="list-loading" class="text-center py-10"><p class="text-slate-400">កំពុងទាញទិន្នន័យរូបភាពនិស្សិត...</p></div>
                        <table id="list-table" class="hidden w-full text-left text-slate-300">
                           <thead class="bg-slate-700/50 sticky top-0"><tr><th class="p-3">ID</th><th class="p-3">ឈ្មោះ</th><th class="p-3">រូបភាព</th><th class="p-3 text-center">Status</th></tr></thead>
                           <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div id="page-records" class="hidden main-content rounded-2xl p-6 h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h1 class="text-2xl text-white khmer-title">រូបភាពបានរក្សាទុក</h1>
                        <div class="flex gap-4 w-full md:w-auto">
                           <input type="text" id="records-search-input" placeholder="Search ID or Name..." class="w-full bg-slate-700 border-slate-600 rounded-lg px-4 py-2">
                           <select id="records-class-filter" class="filter-select w-full md:w-auto"></select>
                        </div>
                    </div>
                    <div id="records-container" class="table-container flex-1 overflow-x-auto">
                        <div id="records-loading" class="text-center py-10"><p class="text-slate-400">កំពុងទាញរូបភាពបានរក្សាទុក...</p></div>
                        <table id="records-table" class="hidden w-full text-left text-slate-300">
                           <thead class="bg-slate-700/50 sticky top-0"><tr><th class="p-3">ល.រ</th><th class="p-3">ឈ្មោះ</th><th class="p-3">ID</th><th class="p-3">ថ្នាក់</th><th class="p-3">ក្រុម</th><th class="p-3">រូបភាព</th><th class="p-3 text-center">កែ</th></tr></thead>
                           <tbody></tbody>
                        </table>
                    </div>
                </div>
            </main>

        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal">
      <!-- MODIFIED: Added 'relative' class -->
      <div class="modal-content w-full max-w-sm p-6 rounded-2xl shadow-2xl text-center relative">

        <!-- NEW: Added the top-left icon back button, hidden by default -->
        <button id="modal-back-btn" class="hidden absolute top-3 left-3 w-10 h-10 bg-slate-700/50 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-slate-600/50 transition z-20" title="Back">
            <i class="fas fa-arrow-left"></i>
        </button>

        <div id="modal-icon" class="w-16 h-16 mx-auto mb-4"></div>
        <p id="modal-message" class="text-lg font-semibold text-white mb-6"></p>
        <div id="modal-buttons" class="flex flex-col sm:flex-row gap-4">
            {/* Buttons will be injected here by JavaScript */}
        </div>
      </div>
    </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyXTQvwmB9RP4Jm3P9n9F-rZRbsljMLq29HvjaOJYPtMq4dF7Tl5wxZbVeznR3ffNCz/exec';
    // DOM Elements
    const video = document.getElementById('video'), captureCanvas = document.getElementById('capture-canvas'),
          photoPreview = document.getElementById('photo-preview'), uploadBtn = document.getElementById('upload-btn'),
          retakeBtn = document.getElementById('retake-btn'), cameraSection = document.getElementById('camera-section'),
          videoWrapper = document.getElementById('video-wrapper'), faceStatus = document.getElementById('face-status'),
          subtitle = document.getElementById('subtitle'), switchCameraBtn = document.getElementById('switch-camera-btn'),
          backBtn = document.getElementById('back-btn'), modal = document.getElementById('modal'),
          modalIcon = document.getElementById('modal-icon'), modalMessage = document.getElementById('modal-message'),
          modalButtons = document.getElementById('modal-buttons'),
          modalBackBtn = document.getElementById('modal-back-btn'), // <-- ADDED THIS
          manualCaptureBtn = document.getElementById('manual-capture-btn');

    const pageScan = document.getElementById('page-scan'), pageRecords = document.getElementById('page-records'), pageList = document.getElementById('page-list'),
          navScan = document.getElementById('nav-scan'), navRecords = document.getElementById('nav-records'), navList = document.getElementById('nav-list'),
          sidebar = document.getElementById('sidebar'), menuBtn = document.getElementById('menu-btn'), sidebarBackdrop = document.getElementById('sidebar-backdrop');

    const selectionArea = document.getElementById('selection-area');
    const studentSearchInput = document.getElementById('student-search-input');
    const studentList = document.getElementById('student-list');

    const recordsLoading = document.getElementById('records-loading'), recordsTable = document.getElementById('records-table'),
          recordsClassFilter = document.getElementById('records-class-filter'), recordsSearchInput = document.getElementById('records-search-input');

    const listLoading = document.getElementById('list-loading'), listTable = document.getElementById('list-table'),
          listClassFilter = document.getElementById('list-class-filter'), listSearchInput = document.getElementById('list-search-input'),
          listTotalCount = document.getElementById('list-total-count'),
          listCompletedCount = document.getElementById('list-completed-count'),
          listPendingCount = document.getElementById('list-pending-count');

    const icons = {
        success: `<svg class="w-full h-full text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        error: `<svg class="w-full h-full text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
        loading: `<div class="w-16 h-16 border-4 border-slate-500 border-t-indigo-500 rounded-full animate-spin"></div>`,
        confirm: `<svg class="w-full h-full text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`,
        choice: `<svg class="w-full h-full text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 13-4-4M3 10h12M3 15h4M4 19h16a1 1 0 0 0 1-1V6a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1z"></path></svg>`
    };

    let studentsData = [], savedRecordsData = [], allStudentsListData = [], currentStream, faceApiInterval, stableFrames = 0, currentFacingMode = 'user', selectedStudent = null, currentCameraMode = 'auto';

    function showModal(type, message, actions = {}) {
        modalIcon.innerHTML = icons[type];
        modalMessage.textContent = message;
        modal.classList.remove('hidden');
        modalButtons.innerHTML = '';

        // NEW: Show/hide the top-left back button based on modal type
        if (type === 'choice') {
            modalBackBtn.classList.remove('hidden');
            modalBackBtn.onclick = () => modal.classList.add('hidden');
        } else {
            modalBackBtn.classList.add('hidden');
        }

        if (type === 'loading') {
            modalBackBtn.classList.add('hidden'); // Ensure it's hidden for loading
            return;
        }

        if (Object.keys(actions).length > 0) {
            for (const [btnText, action] of Object.entries(actions)) {
                const btn = document.createElement('button');
                btn.className = action.className || "w-full bg-slate-600 text-white py-2 rounded-lg font-semibold hover:bg-slate-700 transition";
                btn.textContent = btnText;
                btn.onclick = () => {
                    modal.classList.add('hidden');
                    if (action.callback) action.callback();
                };
                modalButtons.appendChild(btn);
            }
        } else {
             const closeBtn = document.createElement('button');
             closeBtn.className = "w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition";
             closeBtn.textContent = "យល់ព្រម";
             closeBtn.onclick = () => modal.classList.add('hidden');
             modalButtons.appendChild(closeBtn);
        }
    }

    async function loadModels() {
      // MODIFIED: Changed from './weights' to the full CDN URL
      const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
      await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
          faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL),
          faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
      ]);
    }

    async function fetchStudents() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=getStudents`);
        if (!res.ok) throw new Error(`Server error: ${res.status}`);
        const data = await res.json();
        if (data.status === 'error') throw new Error(`Script Error: ${data.message}`);
        studentsData = data.slice(1);
        allStudentsListData = studentsData;
        populateStudentList();
      } catch (e) { showModal('error', `Could not fetch student data: ${e.message}`); }
    }

    function populateStudentList(filter = '') {
        studentList.innerHTML = '';
        const lowerCaseFilter = filter.toLowerCase();
        const filteredStudents = studentsData.filter(s => (s[0] || '').toString().toLowerCase().includes(lowerCaseFilter) || (s[1] || '').toLowerCase().includes(lowerCaseFilter));
        if (filteredStudents.length === 0) { studentList.innerHTML = `<li class="text-center text-slate-400 p-4">No students found.</li>`; return; }

        filteredStudents.forEach(s => {
            const li = document.createElement('li');
            li.className = 'p-3 rounded-lg cursor-pointer transition flex justify-between items-center';
            const uploadCount = s[4];
            if (uploadCount > 0) li.classList.add(`completed`);
            const countIndicator = uploadCount > 0 ? `<i class="fas fa-check-circle ml-2 text-green-400"></i>` : '';
            if (uploadCount > 0) {
                li.style.pointerEvents = 'none'; li.style.opacity = '0.7'; li.style.color = '#4ade80';
            } else {
                // MODIFIED: Changed back to call showCameraModeSelection
                li.onclick = () => {
                    selectedStudent = s;
                    showCameraModeSelection();
                };
            }
            li.innerHTML = `<span>${s[0]} - ${s[1]}</span>` + countIndicator;
            studentList.appendChild(li);
        });
    }

    // ADDED: The function is back, but without the text "Back" button
    function showCameraModeSelection() {
        showModal('choice', 'សូមជ្រើសរើសប្រតិបត្តិកាមេរ៉ា', {
            'ថតរូបស្វ័យប្រវត្តិ': {
                callback: () => startCamera('user', 'auto'),
                className: "w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"
            },
            'ថតរូបដោយខ្លួនឯង': {
                callback: () => startCamera('user', 'manual'),
                className: "w-full bg-slate-600 text-white py-3 rounded-lg font-semibold hover:bg-slate-700 transition"
            }
        });
    }

    function populateClassFilter(records, filterElement) {
        const classes = [...new Set(records.map(r => r[3]).filter(Boolean))];
        filterElement.innerHTML = '<option value="all">All Classes</option>';
        classes.sort().forEach(c => filterElement.innerHTML += `<option value="${c}">${c}</option>`);
    }

    function filterRecordsTable() {
        const selectedClass = recordsClassFilter.value;
        const searchTerm = recordsSearchInput.value.toLowerCase();
        const tbody = recordsTable.querySelector('tbody');
        tbody.innerHTML = '';
        const recordsToDisplay = savedRecordsData.filter(r => {
            const classMatch = selectedClass === 'all' || r[3] === selectedClass;
            const searchMatch = (r[1] || '').toLowerCase().includes(searchTerm) || (r[2] || '').toString().toLowerCase().includes(searchTerm);
            return classMatch && searchMatch;
        });
        if (recordsToDisplay.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-slate-400">No records found.</td></tr>`; return; }
        recordsToDisplay.forEach(record => {
            const serialNumber = record[0]; const imageUrl = record[5];
            const row = document.createElement('tr');
            row.className = 'border-b border-slate-700';
            row.innerHTML = `<td class="p-3">${serialNumber}</td><td class="p-3 whitespace-nowrap">${record[1]}</td><td class="p-3">${record[2]}</td><td class="p-3">${record[3]}</td><td class="p-3">${record[4]}</td><td class="p-3"><a href="${imageUrl}" target="_blank" rel="noopener noreferrer" class="relative block w-16 h-16 group rounded-lg overflow-hidden"><img src="${imageUrl}" class="w-full h-full object-cover" alt="Student photo"><div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center transition-opacity"><i class="fas fa-expand text-white text-xl opacity-0 group-hover:opacity-100 transition-opacity"></i></div></a></td><td class="p-3 text-center"><button class="text-red-400 hover:text-red-600 transition delete-btn"><i class="fas fa-trash-alt"></i></button></td>`;
            row.querySelector('.delete-btn').onclick = () => handleDelete(serialNumber, imageUrl);
            tbody.appendChild(row);
        });
    }

    async function handleDelete(serialNumber, imageUrl) {
        showModal('confirm', 'Are you sure you want to delete this record?', {
            'Cancel': {
                callback: null,
                className: "w-full bg-slate-600 text-white py-2 rounded-lg font-semibold hover:bg-slate-700 transition"
            },
            'Delete': {
                callback: async () => {
                    showModal('loading', 'Deleting...');
                    try {
                        const res = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'delete', serialNumber, imageUrl }),
                            redirect: 'follow'
                        });
                        if (!res.ok) throw new Error(`Server error: ${res.status}`);
                        const r = await res.json();
                        if (r.status === 'success') {
                            showModal('success', "Record deleted!", { 'OK': { callback: async () => {
                                await fetchStudents();
                                await displaySavedRecords();
                                await displayStudentList();
                            }}});
                        } else throw new Error(r.message || "Unknown server error.");
                    } catch (e) { showModal('error', `Delete failed: ${e.message}`); }
                },
                className: "w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition"
            }
        });
    }

    async function displaySavedRecords() {
        recordsLoading.style.display = 'block'; recordsTable.classList.add('hidden');
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getSavedData`);
            if (!res.ok) throw new Error(`Server error: ${res.status}`);
            const data = await res.json();
            savedRecordsData = data.slice(1);
            populateClassFilter(savedRecordsData, recordsClassFilter);
            filterRecordsTable();
            recordsLoading.style.display = 'none';
            recordsTable.classList.remove('hidden');
        } catch(e) { recordsLoading.innerHTML = `<p class="text-red-400">Error: ${e.message}</p>`; }
    }

    function populateListClassFilterV2() {
        const classes = [...new Set(allStudentsListData.map(s => s[2]).filter(Boolean))];
        listClassFilter.innerHTML = '<option value="all">All Students</option>';
        listClassFilter.innerHTML += '<option value="with_photos">With Photos</option>';
        // FIXED: Changed 'filterElement' to 'listClassFilter'
        classes.sort().forEach(c => listClassFilter.innerHTML += `<option value="${c}">${c}</option>`);
    }


    function filterStudentListTable() {
        const selectedFilter = listClassFilter.value;
        const searchTerm = listSearchInput.value.toLowerCase();
        const tbody = listTable.querySelector('tbody');
        tbody.innerHTML = '';
        const imageUrlMap = new Map(savedRecordsData.map(r => [r[2], r[5]]));

        let studentsToDisplay;
        if (selectedFilter === 'all') {
            studentsToDisplay = allStudentsListData;
        } else if (selectedFilter === 'with_photos') {
            studentsToDisplay = allStudentsListData.filter(s => s[4] > 0);
        } else {
            studentsToDisplay = allStudentsListData.filter(s => s[2] === selectedFilter);
        }

        studentsToDisplay = studentsToDisplay.filter(s =>
            (s[0] || '').toString().toLowerCase().includes(searchTerm) ||
            (s[1] || '').toLowerCase().includes(searchTerm)
        );

        let completedCount = studentsToDisplay.filter(s => s[4] > 0).length;
        if (studentsToDisplay.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-slate-400">No students found.</td></tr>`;
        } else {
            studentsToDisplay.forEach(student => {
                const hasImage = student[4] > 0;
                const imageUrl = hasImage ? imageUrlMap.get(student[0].toString()) : null;
                const imageCell = imageUrl
                    ? `<a href="${imageUrl}" target="_blank" rel="noopener noreferrer" class="relative block w-12 h-12 group rounded-lg overflow-hidden mx-auto"><img src="${imageUrl}" class="w-full h-full object-cover" alt="Student photo"></a>`
                    : '<span class="text-slate-500">-</span>';

                const statusIcon = hasImage ? `<i class="fas fa-check-circle text-green-400"></i>` : `<i class="fas fa-times-circle text-red-400"></i>`;
                const row = `<tr class="border-b border-slate-700"><td class="p-3">${student[0]}</td><td class="p-3 whitespace-nowrap">${student[1]}</td><td class="p-3">${imageCell}</td><td class="p-3 text-center">${statusIcon}</td></tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }
        listTotalCount.textContent = studentsToDisplay.length;
        listCompletedCount.textContent = completedCount;
        listPendingCount.textContent = studentsToDisplay.length - completedCount;
    }

    async function displayStudentList() {
        listLoading.style.display = 'block'; listTable.classList.add('hidden');
        if (savedRecordsData.length === 0) {
            try {
                const res = await fetch(`${SCRIPT_URL}?action=getSavedData`);
                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();
                savedRecordsData = data.slice(1);
            } catch (e) { console.error("Could not pre-fetch records for images:", e); }
        }

        listTable.querySelector('thead tr').innerHTML = '<th class="p-3">ID</th><th class="p-3">ឈ្មោះ</th><th class="p-3">រូបភាព</th><th class="p-3 text-center">Status</th>';
        populateListClassFilterV2();
        filterStudentListTable();
        listLoading.style.display = 'none'; listTable.classList.remove('hidden');
    }

    async function startCamera(facingMode = 'user', mode = 'auto') {
        currentFacingMode = facingMode;
        currentCameraMode = mode;
        subtitle.textContent = `Scanning for: ${selectedStudent[1]}`;
        cameraSection.classList.remove('hidden'); selectionArea.classList.add('hidden');
        switchCameraBtn.classList.remove('hidden'); backBtn.classList.remove('hidden');
        stopCamera();
        try {
            const constraints = {
                video: {
                    facingMode,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            currentStream = stream;
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                if (mode === 'auto') {
                    manualCaptureBtn.classList.add('hidden');
                    detectFace();
                } else { // Manual mode
                    manualCaptureBtn.classList.remove('hidden');
                    faceStatus.textContent = "ចុចប៊ូតុងកាមេរ៉ាដើម្បីថត";
                    faceStatus.classList.remove('text-green-400');
                    videoWrapper.classList.remove('ready');
                }
            };
        } catch (err) {
            // MODIFIED: Added a specific fallback for manual mode if auto fails
            if(mode === 'auto') {
                showModal('error', 'Auto-scan camera failed. Please try Manual Capture.', {
                    'Try Manual Capture': {
                        callback: () => startCamera(facingMode, 'manual'),
                        className: "w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"
                    },
                    'Cancel': {
                        callback: () => resetToSelection(),
                        className: "w-full bg-slate-600 text-white py-3 rounded-lg font-semibold hover:bg-slate-700 transition"
                    }
                });
            } else {
                showModal('error', 'Could not start camera. Please check permissions.');
                resetToSelection();
            }
        }
    }

    async function detectFace() {
        const options = new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 });
        clearInterval(faceApiInterval);
        faceApiInterval = setInterval(async () => {
            const result = await faceapi.detectSingleFace(video, options).withFaceLandmarks(true);

            if (result && result.score > 0.7) {
                const landmarks = result.landmarks;
                const nose = landmarks.getNose()[3];
                const leftEyeInner = landmarks.getLeftEye()[3];
                const rightEyeInner = landmarks.getRightEye()[0];
                const faceBox = result.detection.box;

                const videoCenterX = video.videoWidth / 2;
                const faceCenterX = faceBox.x + faceBox.width / 2;
                const centerOffset = Math.abs(faceCenterX - videoCenterX) / video.videoWidth;
                const isCentered = centerOffset < 0.25;

                const eyeCenterX = (leftEyeInner.x + rightEyeInner.x) / 2;
                const poseOffset = Math.abs(nose.x - eyeCenterX) / faceBox.width;
                const isStraight = poseOffset < 0.15;

                const isGoodSize = faceBox.width / video.videoWidth > 0.35;

                if (isCentered && isStraight && isGoodSize) {
                    stableFrames++;
                    faceStatus.textContent = `ល្អណាស់! (${stableFrames}/4)`;
                    faceStatus.classList.add('text-green-400'); videoWrapper.classList.add('ready');
                    if (stableFrames >= 4) captureFace();
                } else {
                    stableFrames = 0;
                    videoWrapper.classList.remove('ready');
                    faceStatus.classList.remove('text-green-400');
                    if (!isGoodSize) faceStatus.textContent = "សូមរំកិលមកជិត";
                    else if (!isCentered) faceStatus.textContent = "សូមតម្រង់មុខអ្នកចំកណ្តាល";
                    else if (!isStraight) faceStatus.textContent = "សូមសម្លឹងមើលកាមេរ៉ាអោយចំ";
                }
            } else {
                stableFrames = 0;
                faceStatus.textContent = "សូមតម្រង់មុខអ្នកចំកណ្តាល";
                faceStatus.classList.remove('text-green-400'); videoWrapper.classList.remove('ready');
            }
        }, 400);
    }


    function captureFace() {
        clearInterval(faceApiInterval);
        const ctx = captureCanvas.getContext('2d');

        const size = 1080;
        captureCanvas.width = size; captureCanvas.height = size;

        if (currentFacingMode === 'user') {
            ctx.translate(size, 0);
            ctx.scale(-1, 1);
        }

        const vRatio = video.videoWidth / video.videoHeight;
        let sx=0, sy=0, sWidth=video.videoWidth, sHeight=video.videoHeight;
        if (vRatio > 1) {
            sHeight = video.videoHeight;
            sWidth = sHeight;
            sx = (video.videoWidth - sWidth) / 2;
        } else {
            sWidth = video.videoWidth;
            sHeight = sWidth;
            sy = (video.videoHeight - sHeight) / 2;
        }

        ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, size, size);

        photoPreview.src = captureCanvas.toDataURL('image/jpeg', 0.85);
        stopCamera();
        switchCameraBtn.classList.add('hidden'); videoWrapper.classList.add('hidden');
        manualCaptureBtn.classList.add('hidden');
        photoPreview.classList.remove('hidden'); uploadBtn.classList.remove('hidden');
        retakeBtn.classList.remove('hidden'); faceStatus.classList.add('hidden');
        subtitle.textContent = "Confirm your photo";
    }

    function stopCamera() {
      if (currentStream) currentStream.getTracks().forEach(t => t.stop());
      clearInterval(faceApiInterval);
    }

    function resetToSelection() {
        stopCamera();
        cameraSection.classList.add('hidden'); switchCameraBtn.classList.add('hidden');
        manualCaptureBtn.classList.add('hidden');
        backBtn.classList.add('hidden'); photoPreview.classList.add('hidden');
        uploadBtn.classList.add('hidden'); retakeBtn.classList.add('hidden');
        videoWrapper.classList.remove('hidden'); selectionArea.classList.remove('hidden');
        subtitle.textContent = "Select your ID or Name"; selectedStudent = null;
    }

    uploadBtn.onclick = async () => {
        if (!selectedStudent) { showModal('error', 'Could not find student data.'); return; }

        const imageData = captureCanvas.toDataURL('image/jpeg', 0.85).split(',')[1];
        showModal('loading', 'Uploading...');
        try {
            const res = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    id: selectedStudent[0], name: selectedStudent[1],
                    class: selectedStudent[2], group: selectedStudent[3],
                    imageData
                }),
                redirect: 'follow'
            });
            if (!res.ok) throw new Error(`Server error: ${res.status}`);
            const r = await res.json();
            if (r.status === 'success') {
                showModal('success', "Image saved successfully!", { 'OK': { callback: async () => {
                    resetToSelection();
                    await fetchStudents();
                }}});
            } else throw new Error(r.message || "Unknown server error.");
        } catch (e) { showModal('error', `Upload failed: ${e.message}`); }
    };

    retakeBtn.onclick = () => {
      photoPreview.classList.add('hidden'); uploadBtn.classList.add('hidden'); retakeBtn.classList.add('hidden');
      videoWrapper.classList.remove('hidden'); faceStatus.classList.remove('hidden');
      stableFrames = 0;
      startCamera(currentFacingMode, currentCameraMode);
    };

    switchCameraBtn.onclick = () => startCamera(currentFacingMode === 'user' ? 'environment' : 'user', currentCameraMode);
    backBtn.onclick = () => resetToSelection();
    studentSearchInput.oninput = () => populateStudentList(studentSearchInput.value);

    manualCaptureBtn.onclick = captureFace;

    const closeSidebar = () => { sidebar.classList.remove('is-open'); sidebarBackdrop.classList.add('hidden'); };
    const navLinks = [navScan, navList, navRecords];
    const pages = [pageScan, pageList, pageRecords];

    navLinks.forEach((link, index) => {
        link.onclick = (e) => {
            e.preventDefault();
            navLinks.forEach(l => l.classList.remove('active'));
            pages.forEach(p => p.classList.add('hidden'));

            link.classList.add('active');
            pages[index].classList.remove('hidden');

            stopCamera();
            if (pages[index] === pageRecords) displaySavedRecords();
            if (pages[index] === pageList) displayStudentList();

            closeSidebar();
        }
    });

    menuBtn.onclick = () => { sidebar.classList.toggle('is-open'); sidebarBackdrop.classList.toggle('hidden'); };
    sidebarBackdrop.onclick = () => closeSidebar();
    recordsClassFilter.onchange = () => filterRecordsTable();
    listClassFilter.onchange = () => filterStudentListTable();
    recordsSearchInput.oninput = () => filterRecordsTable();
    listSearchInput.oninput = () => filterStudentListTable();

    window.onload = async () => {
      document.body.insertAdjacentHTML('afterbegin', `<div id="initial-loading" class="fixed inset-0 flex flex-col items-center justify-center bg-slate-900 z-50"><img src="di_logo.png" alt="Logo" class="w-24 h-24 rounded-full mb-4 shadow-lg"><p class="text-slate-300 text-lg">កំពុងទាញទិន្នន័យប្រព័ន្ធ...</p></div>`);
      await loadModels();
      await fetchStudents();
      document.getElementById('initial-loading').style.display = 'none';
    };
  </script>
</body>
</html>
